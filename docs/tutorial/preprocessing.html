<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2. Data preprocessing &mdash; beamnetresponse 0.0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Updates" href="../updates.html" />
    <link rel="prev" title="1. Format data to ASDF" href="format_data.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> beamnetresponse
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="general.html">Pre-requisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="download_data.html">0. Download data</a></li>
<li class="toctree-l2"><a class="reference internal" href="format_data.html">1. Format data to ASDF</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2. Data preprocessing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../updates.html">Updates</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">beamnetresponse</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../tutorial.html">Tutorial</a> &raquo;</li>
      <li>2. Data preprocessing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorial/preprocessing.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="data-preprocessing">
<h1>2. Data preprocessing<a class="headerlink" href="#data-preprocessing" title="Permalink to this headline">ÔÉÅ</a></h1>
<p>The data are almost ready: we need to preprocess them. From the <cite>scripts</cite> folder, run <cite>2_preprocessing.py</cite>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ipython 2_preprocessing.py
</pre></div>
</div>
<p>This script bandpass filter the seismograms between 2 Hz and 12 Hz, which is an appropriate bandwidth for studying small earthquakes (M &lt; 2) at typical source-receiver distances of 10-50 km. The data are also downsampled to 25 Hz, that is, down to a Nyquist frequency that is just above the upper frequency of our filter. Of course, you can tune the parameters of this script to play with different preprocessings. You can also see that, here, we use another powerful feature of the <code class="xref py py-data docutils literal notranslate"><span class="pre">pyasdf</span></code> package which is the effortless parallelization of the preprocessing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">path_script</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_script</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">utils</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">give_time</span>

<span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">Stream</span>
<span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span> <span class="k">as</span> <span class="n">udt</span>

<span class="k">def</span> <span class="nf">lowpass_chebyshev_II</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">freqmax</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">,</span>
                         <span class="n">order</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_attenuation_dB</span><span class="o">=</span><span class="mf">40.</span><span class="p">,</span> <span class="n">zerophase</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">cheby2</span><span class="p">,</span> <span class="n">sosfilt</span>

    <span class="n">nyquist</span> <span class="o">=</span> <span class="n">sampling_rate</span><span class="o">/</span><span class="mf">2.</span>

    <span class="n">sos</span> <span class="o">=</span> <span class="n">cheby2</span><span class="p">(</span><span class="n">order</span><span class="p">,</span>
                 <span class="n">min_attenuation_dB</span><span class="p">,</span>
                 <span class="c1">#freqmax/nyquist,</span>
                 <span class="n">freqmax</span><span class="p">,</span>
                 <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">fs</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span>
                 <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;lowpass&#39;</span><span class="p">,</span>
                 <span class="n">output</span><span class="o">=</span><span class="s1">&#39;sos&#39;</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">sosfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zerophase</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">sosfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">X</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">X</span>


<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">freqmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freqmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">target_SR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remove_response</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">remove_sensitivity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_resp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">target_duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;VEL&#39;</span><span class="p">,</span>
               <span class="n">target_starttime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_endtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">preprocessed_st</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input data is empty!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">preprocessed_st</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too many gaps!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">preprocessed_st</span>
    <span class="c1"># ----------------------------------</span>
    <span class="c1"># start by cleaning the gaps if there are any</span>
    <span class="c1"># ----------------------------------</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problem with </span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> (detected NaNs)!&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># split will lose information about start and end times</span>
        <span class="c1"># if the start or the end is masked</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">udt</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">udt</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
        <span class="c1"># it&#39;s now safe to fill the gaps with zeros</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">t2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">preprocessed_st</span> <span class="o">+=</span> <span class="n">tr</span>
    <span class="c1"># if the trace came as separated segments without masked elements,</span>
    <span class="c1"># it is necessary to merge the stream</span>
    <span class="n">preprocessed_st</span> <span class="o">=</span> <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target_starttime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">target_starttime</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target_endtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">endtime</span><span class="o">=</span><span class="n">target_endtime</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="c1"># delete the original data to save memory</span>
    <span class="k">del</span> <span class="n">st</span>
    <span class="c1"># ----------------------------------</span>
    <span class="c1">#      resample if necessary</span>
    <span class="c1"># ----------------------------------</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">preprocessed_st</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target_SR</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">sr_ratio</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="o">/</span><span class="n">target_SR</span>
        <span class="k">if</span> <span class="n">sr_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">lowpass_chebyshev_II</span><span class="p">(</span>
                       <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mf">0.48</span><span class="o">*</span><span class="n">target_SR</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span>
                       <span class="n">order</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_attenuation_dB</span><span class="o">=</span><span class="mf">40.</span><span class="p">,</span> <span class="n">zerophase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sr_ratio</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">sr_ratio</span><span class="p">:</span>
                <span class="c1"># tr&#39;s sampling rate is an integer</span>
                <span class="c1"># multiple of target_SR</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sr_ratio</span><span class="p">),</span> <span class="n">no_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">target_SR</span><span class="p">,</span> <span class="n">no_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sr_ratio</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Requested sampling rate is too high!&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="c1"># ----------------------------------</span>
    <span class="c1">#    adjust length if requested</span>
    <span class="c1"># ----------------------------------</span>
    <span class="k">if</span> <span class="n">target_duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">preprocessed_st</span><span class="p">)):</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span>
                    <span class="n">target_duration</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">preprocessed_st</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span>
            <span class="n">preprocessed_st</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">preprocessed_st</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]</span>
    <span class="c1"># ----------------------------------</span>
    <span class="c1">#   remove response if requested</span>
    <span class="c1"># ----------------------------------</span>
    <span class="c1"># -- attach the metadata</span>
    <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">attach_response</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remove_response</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">preprocessed_st</span><span class="p">:</span>
            <span class="c1"># assume that the instrument response</span>
            <span class="c1"># is already attached to the trace</span>
            <span class="n">T_max</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="o">*</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
            <span class="n">T_min</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
            <span class="n">f_min</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">T_max</span>
            <span class="n">f_max</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">T_min</span><span class="p">)</span>
            <span class="n">pre_filt</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_min</span><span class="p">,</span> <span class="mf">3.</span><span class="o">*</span><span class="n">f_min</span><span class="p">,</span> <span class="mf">0.90</span><span class="o">*</span><span class="n">f_max</span><span class="p">,</span> <span class="mf">0.97</span><span class="o">*</span><span class="n">f_max</span><span class="p">]</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">remove_response</span><span class="p">(</span><span class="n">pre_filt</span><span class="o">=</span><span class="n">pre_filt</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot_resp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">remove_sensitivity</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">preprocessed_st</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">remove_sensitivity</span><span class="p">()</span>
    <span class="c1"># ----------------------------------</span>
    <span class="c1">#            filter</span>
    <span class="c1"># ----------------------------------</span>
    <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">freqmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">freqmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># no filtering</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">freqmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># lowpass filtering</span>
        <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;lowpass&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freqmax</span><span class="p">,</span> <span class="n">zerophase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">freqmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># highpass filtering</span>
        <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;highpass&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freqmin</span><span class="p">,</span> <span class="n">zerophase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># bandpass filtering</span>
        <span class="n">preprocessed_st</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;bandpass&#39;</span><span class="p">,</span> <span class="n">freqmin</span><span class="o">=</span><span class="n">freqmin</span><span class="p">,</span>
                               <span class="n">freqmax</span><span class="o">=</span><span class="n">freqmax</span><span class="p">,</span> <span class="n">zerophase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">preprocessed_st</span>


<span class="k">def</span> <span class="nf">preprocess_asdf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">path_data</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
    <span class="n">_preprocess</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">preprocess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># tag map defining which traces are taken as input (raw)</span>
    <span class="c1"># and what is the tag name of the output (tag_name)</span>
    <span class="n">tag_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">tag_name</span><span class="p">}</span>

    <span class="c1"># full output filename</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">path_data</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.h5&#39;</span><span class="p">)</span>

    <span class="n">ds</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">_preprocess</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">tag_map</span><span class="p">)</span>

    <span class="c1"># this is necessary if using the MPI version of pyasdf</span>
    <span class="k">del</span> <span class="n">ds</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyasdf</span> <span class="kn">import</span> <span class="n">ASDFDataSet</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

    <span class="c1"># I/O variables:</span>
    <span class="n">path_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_script</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="n">data_filename</span> <span class="o">=</span> <span class="s1">&#39;data_20120726_raw.h5&#39;</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="s1">&#39;data_20120726&#39;</span>

    <span class="c1"># preprocessing parameters</span>
    <span class="n">tag_name</span> <span class="o">=</span> <span class="s1">&#39;preprocessed_2_12&#39;</span>
    <span class="n">target_SR</span> <span class="o">=</span> <span class="mf">25.</span> <span class="c1"># H</span>
    <span class="n">target_starttime</span> <span class="o">=</span> <span class="n">udt</span><span class="p">(</span><span class="s1">&#39;2012-07-26&#39;</span><span class="p">)</span>
    <span class="n">target_endtime</span> <span class="o">=</span> <span class="n">target_starttime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">freqmin</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="c1"># Hz</span>
    <span class="n">freqmax</span> <span class="o">=</span> <span class="mf">12.0</span> <span class="c1"># Hz</span>
    <span class="n">remove_response</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># remove the target file if already existing</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">output_filename</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Overwrite the existing </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="c1"># load the raw data</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ASDFDataSet</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">data_filename</span><span class="p">))</span>

    <span class="c1"># start preprocessing</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Start preprocessing </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">data_filename</span><span class="p">)</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
    <span class="n">preprocess_asdf</span><span class="p">(</span>
            <span class="n">ds</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">path_data</span><span class="o">=</span><span class="n">path_data</span><span class="p">,</span>
            <span class="n">target_SR</span><span class="o">=</span><span class="n">target_SR</span><span class="p">,</span> <span class="n">freqmin</span><span class="o">=</span><span class="n">freqmin</span><span class="p">,</span> <span class="n">freqmax</span><span class="o">=</span><span class="n">freqmax</span><span class="p">,</span>
            <span class="n">target_starttime</span><span class="o">=</span><span class="n">target_starttime</span><span class="p">,</span> <span class="n">target_endtime</span><span class="o">=</span><span class="n">target_endtime</span><span class="p">,</span>
            <span class="n">remove_response</span><span class="o">=</span><span class="n">remove_response</span><span class="p">)</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="format_data.html" class="btn btn-neutral float-left" title="1. Format data to ASDF" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../updates.html" class="btn btn-neutral float-right" title="Updates" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Eric Beauce and William B. Frank.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>